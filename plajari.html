<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plajari Sukoharjo Corporate University</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Montserrat !important;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      color: #333;
    }

    header {
      text-align: center;
      background: linear-gradient(rgba(27, 60, 83, 0.8), rgba(27, 60, 83, 0.8)), url("backmooc.png") no-repeat center center;
      background-size: cover;
      padding: 60px 20px;
      color: white;
    }

    header h1 {
      margin: 0;
      font-size: 35px;
      font-weight: heavy;
      color: #FFD700 !important;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    header h2 {
      margin: 0;
      font-size: 33px;
      font-weight: heavy;
      color: #ffffff !important;
    }

    nav {
      display: flex;
      justify-content: center;
      width: 100%;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }   

    nav button {
      flex: 1;
      padding: 15px;
      border: none;
      background: #fff;
      color: #456882;
      font-family: Montserrat;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    nav button.active {
       background: #f8f9fa;
       color: #1B3C53;
       border-bottom: 3px solid #8C1007; /* Merah Maron Sukoharjo */
    }

    nav button:hover {
      background: #f1f1f1;
    }


    .container {
      display: grid;
      /* Menggunakan auto-fill agar ukuran card tetap konsisten (tidak melebar jika hanya 1) */
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
      /* Tambahkan ini agar grid tidak memaksa konten ke tengah jika cuma sedikit */
      justify-content: start; 
    }


    .card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      border: 1px solid #eee;
      /* Tambahkan ini agar tinggi kartu konsisten dalam satu baris */
      height: 100%; 
    }


    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }

    .card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .card h3 {
      margin: 15px 10px;
      font-size: 18px;
      color: #1B3C53;
    }

    .card a {
      display: block;
      background: linear-gradient(135deg, #1b3c53, #0a2130);
      color: #fff;
      text-decoration: none;
      padding: 12px;
      margin: 10px 15px;
      border-radius: 8px;
      transition: background 0.3s ease;
      font-weight: bold;
    }

    .card a:hover {
      background: #28a745;
    }

    .status-icon {
      font-size: 22px;
      margin-top: 15px;
      display: block;
    }

    .card button {
      background: #1B3C53;
      font-family: Montserrat;
      color: #fff;
      border: none;
      padding: 10px;
      margin: 0 15px 15px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .card button.start {
      background: linear-gradient(135deg, #1b3c53, #0a2130);
      color: #fff;
    }

    .card button.start:hover {
      background: linear-gradient(135deg, #1aa179, #218838) !important;
      transform: scale(1.03);
    }

    .card button.read:disabled {
      background: linear-gradient(135deg, #1aa179, #218838) !important;
      opacity: 1;
    }

    footer {
      text-align: center;
      padding: 15px;
      background: #1B3C53;
      color: #fff;
      margin-top: 30px;
    }

    .card button.eval {
      background: linear-gradient(135deg, #0d6efd, #043070);
      margin-bottom: 10px;
      margin-above: 10px;
    }

    .card button.eval:hover {
      background: linear-gradient(135deg, #0d6efd, #043070);
    }

    footer {
      text-align: center;
      padding: 15px;
      background: #1B3C53;
      color: #fff;
      margin-top: 30px;
    }

    .card button.sertif {
      background: linear-gradient(135deg, #1aa179, #218838);
      margin-bottom: 15px;
    }

    .card button.sertif:hover {
      background: linear-gradient(135deg, #1aa179, #218838);
    }

    footer {
      text-align: center;
      padding: 15px;
      background: #1B3C53;
      color: #fff;
      margin-top: 30px;
    }

    .card button:disabled {
      background: #adb5bd !important;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .progress-wrapper {
      margin: 12px 15px 5px;
      background: #e0e0e0;
      border-radius: 20px; /* Lebih lonjong */
      height: 14px; /* Sedikit lebih tebal */
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      /* Gradasi warna dari oranye ke hijau sukses */
      background: linear-gradient(90deg, #f0ad4e, #5cb85c, #28a745);
      background-size: 200% 100%;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); /* Gerakan smooth */
      border-radius: 20px;
      position: relative;
    }

    /* Efek cahaya bergerak pada progress bar */
    .progress-bar::after {
      content: "";
      position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background-image: linear-gradient(
        -45deg, 
        rgba(255, 255, 255, .2) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255, 255, 255, .2) 50%, 
        rgba(255, 255, 255, .2) 75%, 
        transparent 75%, 
        transparent
      );
      z-index: 1;
      background-size: 50px 50px;
      animation: moveStripes 2s linear infinite;
    }

    @keyframes moveStripes {
      0% { background-position: 0 0; }
      100% { background-position: 50px 50px; }
    }

    .progress-text {
      font-size: 11px;
      margin: 0 15px;
      color: #1B3C53;
      font-weight: 700;
      display: flex;
      justify-content: space-between; /* Menaruh label di kiri dan % di kanan */
    }

    .card button.eval:not(:disabled) {
      animation: pulse-blue 2s infinite;
    }


    @keyframes pulse-blue {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
      70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-box {
      transform: scale(1);
    }

    .modal-box h3 {
      margin-top: 0;
      color: #1B3C53;
    }

    .modal-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }

    .modal-actions button {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-cancel {
      background: #adb5bd;
      color: #fff;
    }

    .btn-confirm {
      background: #28a745;
      color: #fff;
    }

    /* ===== ANIMASI TAB ===== */
    .container {
      animation: fadeSlide 0.4s ease;
    }

    @keyframes fadeSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Highlight materi baru dipelajari */
    .card.highlight {
      animation: highlightPulse 2s ease;
      border: 2px solid #1aa179;
    }

    @keyframes highlightPulse {
      0% {
        box-shadow: 0 0 0 rgba(26, 161, 121, 0.0);
        background-color: #f8fffb;
      }
      30% {
        box-shadow: 0 0 20px rgba(26, 161, 121, 0.6);
        background-color: #eafff6;
      }
      100% {
        box-shadow: 0 0 0 rgba(26, 161, 121, 0.0);
        background-color: #ffffff;
      }
    }

    /* Label materi baru dibaca */
    .badge-new {
      position: absolute;
      top: 12px;
      left: 12px;
      background: linear-gradient(135deg, #1aa179, #218838);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      z-index: 2;
      animation: badgePop 0.5s ease;
    }

    @keyframes badgePop {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Label selesai dipelajari */
    .badge-complete {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, #28a745, #1aa179);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      z-index: 2;
      animation: badgePop 0.5s ease;
    }

    /* Label terakhir dipelajari (tanpa background) */
    .label-time {
      margin: 6px 15px 0;
      font-size: 12px;
      font-weight: 600;
      color: #8C1007; /* merah maroon */
      text-align: left;
    }

    .card.completed {
      border: 2px solid #28a745;
    }

    .timer-selesai {
      color: #1aa179; /* hijau */
      font-weight: 700;
    }

    .step-guide {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      margin: 20px;
      border-radius: 10px;
      font-size: 14px;
      color: #856404;
    }

    .step-guide b { color: #1B3C53; }


    #toast {
      position: fixed;
      bottom: 50px; /* Lebih naik agar tidak tertutup nav bar HP */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(40, 167, 69, 0.95); /* Hijau transparan */
      color: white;
      padding: 12px 25px;
      border-radius: 50px; /* Bentuk kapsul lebih modern */
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 10001; /* Pastikan di atas modal */
      font-size: 14px;
      text-align: center;
      white-space: nowrap;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp { 
      from { bottom: 0; opacity: 0; } 
      to { bottom: 50px; opacity: 1; } 
    }

   /* Style untuk Latar Belakang Pop-up */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85); /* Gelap transparan */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999; /* Agar selalu di depan */
    }

    /* Kotak Form Login */
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: scaleUp 0.3s ease-out;
    }

    @keyframes scaleUp {
      from { transform: scale(0.7); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .hidden {
      display: none !important;
    }

    #user-info-bar {
      background: #f1f1f1;
      padding: 10px 20px;
      text-align: right;
      font-size: 14px;
      border-bottom: 1px solid #ddd;
    }

    @media (max-width: 480px) {
      body {
        font-family: Montserrat !important;
        margin: 0;
        padding: 0;
        color: #333;
      }

      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #1B3C53;
      }

      header h2 {
        margin: 0;
        font-size: 17px;
        font-weight: 600;
        color: #8C1007;
      }
    }
  </style>
</head>
<body>

  <div id="user-info-bar" class="hidden">
      Selamat Datang, <b id="user-name"></b> | 
      <button onclick="handleLogout()" style="color:red; cursor:pointer; border:none; background:none; text-decoration:underline;">Keluar</button>
    </div>

    <div id="login-modal" class="modal-overlay">
      <div class="modal-content">
        <img src="logo-sukoharjo.png" alt="Logo" style="width: 80px; margin-bottom: 15px;">
        <h2 style="color: #1B3C53; margin-bottom: 5px;">Login ASN</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Silahkan masukkan NIP Anda untuk mengakses materi belajar.</p>
    
        <input type="text" id="nip-input" placeholder="Masukkan NIP" 
            style="width: 80%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;">
    
        <button id="btn-login" onclick="handleLogin()" 
            style="width: 87%; padding: 12px; background: #1B3C53; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
          Masuk ke Platform
        </button>
    
        <p id="login-msg" style="color: red; font-size: 12px; margin-top: 10px;"></p>
      </div>
    </div>
  
  <header>
    <h1>Platform Belajar Mandiri (PLAJARI)</h1>
    <h2>Sukoharjo Corporate University</h2>
    <div id="userStats" style="margin-top: 20px; display: flex; justify-content: center; gap: 20px; font-size: 15px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto; border: 1px solid rgba(255,255,255,0.3);">
        <span title="Materi yang sedang dipelajari">üìñ <b id="statTotal">0</b> Materi Dibaca</span>
        <span title="Sertifikat yang sudah didapat">üéì <b id="statDone">0</b> Selesai</span>
    </div>
  </header>


  <div class="step-guide">
    <b>Alur Belajar:</b> 1. Pilih Materi di "Belum Dibaca" ‚ûî 2. Klik "Mulai Belajar" ‚ûî 3. Tonton Video & Baca Modul (Min. 5 Menit) ‚ûî 4. Ceklis Status ‚ûî 5. Cetak Sertifikat.
  </div>

  <main>
    <div style="max-width: 1200px; margin: 20px auto 0; padding: 0 20px;">
      <div style="position: relative;">
        <input type="text" id="searchInput" placeholder="Cari judul materi (contoh: Probis, IT, Komunikasi)..." 
               style="width: 100%; padding: 15px 15px 15px 45px; border-radius: 12px; border: 2px solid #ddd; font-family: Montserrat; font-size: 16px; outline: none; transition: border-color 0.3s;">
        <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888;">üîç</span>
      </div>
    </div>

  <!-- Menu navigasi -->
  <nav>
    <button id="btn-all" class="active">Semua Materi</button>
    <button id="btn-unread">Belum Dibaca</button>
    <button id="btn-read">Sudah Dibaca</button>
  </nav>

  <main>
    <div class="container" id="materi-container"></div>
  </main>

  <footer>
    <p>&copy; 2025 Plajari Sukoharjo Corporate University</p>
  </footer>

  <script>
    // Daftar Materi
    const materiList = [
      {id:1, judul:"Penyusunan Probis", img:"../gambarmateri/probis.jpg", link:"https://sukodrive.sukoharjokab.go.id/s/8cki26fks84BkAo/preview", sertifikat: "https://docs.google.com/forms/d/e/1FAIpQLSf-9cmbsosbqx65AMaFdQtVhoNd_-_zT5tPvYc4F9YT4DVrSA/viewform?embedded=true", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:2, judul:"Manajemen Risiko", img:"https://via.placeholder.com/300x160?text=Materi+2", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:3, judul:"Public Speaking", img:"https://via.placeholder.com/300x160?text=Materi+3", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:4, judul:"Pelatihan IT Dasar", img:"https://via.placeholder.com/300x160?text=Materi+4", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:5, judul:"Komunikasi Efektif", img:"https://via.placeholder.com/300x160?text=Materi+5", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:6, judul:"Manajemen Kepegawaian", img:"https://via.placeholder.com/300x160?text=Materi+6", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:7, judul:"Pelayanan Publik", img:"https://via.placeholder.com/300x160?text=Materi+7", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:8, judul:"Literasi Digital", img:"https://via.placeholder.com/300x160?text=Materi+8", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:9, judul:"Anti Korupsi", img:"https://via.placeholder.com/300x160?text=Materi+9", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:10, judul:"Manajemen Keuangan", img:"https://via.placeholder.com/300x160?text=Materi+10", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:11, judul:"Kedisiplinan", img:"https://via.placeholder.com/300x160?text=Materi+11", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:12, judul:"Teamwork & Kolaborasi", img:"https://via.placeholder.com/300x160?text=Materi+12", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:13, judul:"Kreativitas & Inovasi", img:"https://via.placeholder.com/300x160?text=Materi+13", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:14, judul:"Administrasi", img:"https://via.placeholder.com/300x160?text=Materi+14", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:15, judul:"Analisis Data", img:"https://via.placeholder.com/300x160?text=Materi+15", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:16, judul:"Manajemen Bangkom", img:"https://via.placeholder.com/300x160?text=Materi+16", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:17, judul:"Kearsipan", img:"https://via.placeholder.com/300x160?text=Materi+17", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:18, judul:"K3 (Keselamatan Kerja)", img:"https://via.placeholder.com/300x160?text=Materi+18", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:19, judul:"Protokol dan Humas", img:"https://via.placeholder.com/300x160?text=Materi+19", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"},
      {id:20, judul:"Cyber Security", img:"https://via.placeholder.com/300x160?text=Materi+20", link:"https://drive.google.com/", sertifikat: "https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital", download:"https://www.sipenata.sukoharjokab.go.id/bangkom/ajukan-sertifikat-digital"}
    ];

    // Ambil status baca dari localStorage
    let readStatus = JSON.parse(localStorage.getItem("readStatus")) || {};
    let openedStatus = JSON.parse(localStorage.getItem("openedStatus")) || {};
    let printedStatus = JSON.parse(localStorage.getItem("printedStatus")) || {};
    let checkedStatus = JSON.parse(localStorage.getItem("checkedStatus")) || {};
    let videoStatus = JSON.parse(localStorage.getItem("videoStatus")) || {};
    let modulStatus = JSON.parse(localStorage.getItem("modulStatus")) || {};
    let lastMovedMateriId = null;
    let readTime = JSON.parse(localStorage.getItem("readTime")) || {};
    let hasAutoScrolled = false; // pengunci: scroll hanya sekali per sesi
    let newBadgeShown = JSON.parse(localStorage.getItem("newBadgeShown")) || {};
    let studyTime = JSON.parse(localStorage.getItem("studyTime")) || {};
    let studyStart = JSON.parse(localStorage.getItem("studyStart")) || {};
    let evalStatus = JSON.parse(localStorage.getItem("evalStatus")) || {};

    // GANTI DENGAN URL APPS SCRIPT ANDA
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby2wnG78EdwInXdQTVSyhKTO9yk5yWgL4qjRLU2rPzcODXtimCgHOEexaHqo9Rcxt_StQ/exec"; 

    let currentUserNip = localStorage.getItem("plajari_nip") || null;

    // Satukan semua status ke dalam satu objek 'state' agar mudah dikirim ke Cloud
    let state = JSON.parse(localStorage.getItem("plajari_state")) || {
      opened: JSON.parse(localStorage.getItem("openedStatus")) || {},
      startTime: JSON.parse(localStorage.getItem("studyStart")) || {},
      checklist: JSON.parse(localStorage.getItem("checkedStatus")) || {},
      printed: JSON.parse(localStorage.getItem("printedStatus")) || {}
    };

    window.onload = function() {
      const modal = document.getElementById('login-modal');
      const infoBar = document.getElementById('user-info-bar');

      if (currentUserNip) {
        // Jika sudah login
        modal.classList.add('hidden');
        infoBar.classList.remove('hidden');
        // Ambil nama dari memori atau database
        document.getElementById('user-name').innerText = "ASN"; 
        renderMateri("all"); 
      } else {
        // Jika belum login, pastikan pop-up muncul
        modal.classList.remove('hidden');
      }
    };

    async function handleLogin() {
      const nipInput = document.getElementById('nip-input').value;
      const btn = document.getElementById('btn-login');
      const msg = document.getElementById('login-msg');

      if (!nipInput) return alert("Silahkan masukkan NIP!");

      btn.innerText = "Memverifikasi...";
      btn.disabled = true;

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'login', nip: nipInput })
        });
        const data = await response.json();

        if (data.success) {
          currentUserNip = nipInput;
          localStorage.setItem("plajari_nip", nipInput);
          document.getElementById('user-name').innerText = data.nama;
          document.getElementById('login-modal').classList.add('hidden');
          document.getElementById('user-info-bar').classList.remove('hidden');
          renderMateri("all");
        } else {
          msg.innerText = data.message;
        }
      } catch (err) {
        msg.innerText = "Koneksi ke Database Gagal!";
      } finally {
        btn.innerText = "Masuk ke Platform";
        btn.disabled = false;
      }
    }

    let currentActiveId = null; 
    let currentEvalUrl = ""; // Variabel sementara untuk menyimpan link form
    let currentEvalId = null; // Variabel sementara untuk menyimpan ID materi

    const MIN_WAKTU_BELAJAR = 1 * 60 * 1000; // 5 menit (dalam milidetik)
  
    const container = document.getElementById("materi-container");

    function updateStats() {
       // Menghitung jumlah materi yang sudah diklik "Mulai Belajar" (readStatus)
       const totalRead = Object.values(readStatus).filter(status => status === true).length;
   
       // Menghitung jumlah materi yang sudah mengerjakan evaluasi (evalStatus)
       const totalDone = Object.values(evalStatus).filter(status => status === true).length;
     
       // Update teks di header
       const statTotalEl = document.getElementById("statTotal");
       const statDoneEl = document.getElementById("statDone");

       if (statTotalEl) statTotalEl.innerText = totalRead;
       if (statDoneEl) statDoneEl.innerText = totalDone;
    }



function urutkanMateri(materiArray, filter) {
  if (filter !== "read" || !lastMovedMateriId) {
    return materiArray;
  }

  const terbaru = materiArray.find(m => m.id === lastMovedMateriId);
  const lainnya = materiArray.filter(m => m.id !== lastMovedMateriId);

  return terbaru ? [terbaru, ...lainnya] : materiArray;
}

function renderMateri(filter = "all") {
  container.innerHTML = "";

  // A. Ambil apa yang diketik user di kotak pencarian (ubah jadi huruf kecil semua)
  const kataKunci = document.getElementById("searchInput") ? document.getElementById("searchInput").value.toLowerCase() : "";

  // B. Ambil materi berdasarkan kategori (Semua/Belum/Sudah)
  let dataRender = urutkanMateriPermanen(materiList, filter);

  // C. LOGIKA FILTER: Saring lagi berdasarkan judul
  dataRender = dataRender.filter(materi => {
    // Mengecek apakah judul materi mengandung kata kunci yang diketik
    return materi.judul.toLowerCase().includes(kataKunci);
  });

  // D. Tambahan: Jika hasil pencarian tidak ada, tampilkan pesan "Tidak ditemukan"
  if (dataRender.length === 0 && kataKunci !== "") {
    container.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <p>Materi dengan judul "<b>${kataKunci}</b>" tidak ditemukan.</p>
      </div>`;
    return; // Berhenti di sini, jangan lanjut ke looping di bawah
  }

  dataRender.forEach(materi => {
    const isRead = readStatus[materi.id] === true;

    const waktuSkr = getWaktuBelajarAktif(materi.id); const sisa = MIN_WAKTU_BELAJAR - waktuSkr;         
    const selesai = waktuSkr >= MIN_WAKTU_BELAJAR;

    if (filter === "read" && !isRead) return;
    if (filter === "unread" && isRead) return;

    const card = document.createElement("div");
    card.className = "card";
    card.id = `materi-${materi.id}`;

    // jika sertifikat sudah dicetak ‚Üí tandai card sebagai selesai
    if (printedStatus[materi.id]) {
      card.classList.add("completed");
    }

    // label BARU ‚Üí hanya muncul SEKALI
    let badgeHtml = "";
    if (
      materi.id === lastMovedMateriId &&
      filter === "read" &&
      !newBadgeShown[materi.id]
    ) {
      badgeHtml = `<div class="badge-new">BARU</div>`;

      // ‚ú® highlight HANYA SEKALI (ikut badge)
      card.classList.add("highlight");

      // tandai bahwa badge + highlight sudah pernah ditampilkan
      newBadgeShown[materi.id] = true;
      localStorage.setItem("newBadgeShown", JSON.stringify(newBadgeShown));
    }

    // label jika materi sudah selesai (sertifikat dicetak)
    let completeBadgeHtml = "";
    if (printedStatus[materi.id]) {
      completeBadgeHtml = `<div class="badge-complete">SELESAI DIPELAJARI</div>`;
    }

    let html = `
      ${badgeHtml}
      ${completeBadgeHtml}
      <img src="${materi.img}" alt="${materi.judul}">
      <h3>${materi.judul}</h3>
    `;

    if (filter === "read") {
      html += `
        <button class="start" style="width: calc(100% - 30px); margin: 10px 15px;" onclick="markOpened(${materi.id})">
          Lihat Video Materi
        </button>


        ${readTime[materi.id] ? `
          <div class="label-time">
            Terakhir dipelajari: ${formatTanggalJam(readTime[materi.id])}
          </div>
        ` : ""}
      `;
    }

    if (filter !== "read") {
      if (!isRead) {
        html += `
          <button class="start" onclick="openModal(${materi.id})">
            Mulai Belajar
          </button>
        `;
      } else {
        html += `
          <button class="read" disabled>
            Sudah Dipelajari
          </button>
        `;
      }
    }

    if (filter === "read" && isRead) {
      const waktuSkr = getWaktuBelajarAktif(materi.id);
      const sisa = MIN_WAKTU_BELAJAR - waktuSkr;

      const timeOk = waktuSkr >= MIN_WAKTU_BELAJAR;
      const videoOk = videoStatus[materi.id] === true;
      const modulOk = modulStatus[materi.id] === true;
      
      // Syarat untuk bisa klik tombol Evaluasi
      const canEval = timeOk && videoOk && modulOk;
      
      // Syarat final: Apakah sudah mengerjakan evaluasi?
      const isEvalDone = evalStatus[materi.id] === true;

      html += `
        <div class="label-time">
        ‚è≥ Waktu belajar:
            <span id="timer-${materi.id}" class="${timeOk ? 'timer-selesai' : ''}">
              ${timeOk ? 'SELESAI' : formatCountdown(sisa)}
            </span>
        </div>

        <div style="text-align:left; margin:10px 15px; font-size:13px">
          <label>
            <input type="checkbox" ${videoOk ? "checked" : ""} ${printedStatus[materi.id] || !timeOk ? "disabled" : ""} onchange="toggleVideo(${materi.id})">
            Video telah dipelajari
          </label><br>
          <label>
            <input type="checkbox" ${modulOk ? "checked" : ""} ${printedStatus[materi.id] ? "disabled" : ""} onchange="toggleModul(${materi.id})">
            Modul telah dipelajari
          </label>
        </div>

                <div style="text-align: left; margin: 10px 15px; font-size: 11px; padding: 8px; background: #fdf2f2; border-radius: 5px; border: 1px solid #f8d7da;">
          <b style="color: #1B3C53; display: block; margin-bottom: 3px;">Syarat Kelulusan:</b>
          <span style="color: ${timeOk ? '#28a745' : '#dc3545'}">${timeOk ? '‚úî' : '‚úñ'} Minimal Belajar 5 Menit</span><br>
          <span style="color: ${videoOk ? '#28a745' : '#dc3545'}">${videoOk ? '‚úî' : '‚úñ'} Video Materi Selesai</span><br>
          <span style="color: ${modulOk ? '#28a745' : '#dc3545'}">${modulOk ? '‚úî' : '‚úñ'} Modul Materi Selesai</span><br>
          <span style="color: ${isEvalDone ? '#28a745' : '#dc3545'}">${isEvalDone ? '‚úî' : '‚úñ'} Kerjakan Evaluasi Belajar</span>
        </div>

        <div class="progress-text">
           <span>Progres Belajar</span>
           <span>${hitungProgress(materi.id)}%</span>
        </div>
        <div class="progress-wrapper">
           <div class="progress-bar" style="width:${hitungProgress(materi.id)}%"></div>
        </div>

        <button class="eval"
          ${!canEval || isEvalDone ? "disabled" : ""}
          onclick="openSertifikat('${materi.sertifikat}', ${materi.id})">
          ${isEvalDone ? 'EVALUASI SELESAI' : 'KERJAKAN EVALUASI'}
        </button>

        <button class="sertif"
          ${!isEvalDone ? "disabled" : ""}
          onclick="openDownload('${materi.download}')">
          DOWNLOAD SERTIFIKAT
        </button>
      `;

     updateStats();
    }


    card.innerHTML = html;
    container.appendChild(card);

  });

  // ‚úÖ AUTO SCROLL (DI LUAR forEach, MASIH DI DALAM renderMateri)
  // AUTO SCROLL hanya sekali per sesi
if (filter === "read" && lastMovedMateriId && !hasAutoScrolled) {
  setTimeout(() => {
    const target = document.getElementById(`materi-${lastMovedMateriId}`);
    if (target) {
      target.scrollIntoView({behavior: "smooth", block: "center"});

      const modalInstruksi = document.getElementById("instructionModal");
      if (modalInstruksi) {
        modalInstruksi.classList.add("show");
      }

      hasAutoScrolled = true; // üîí KUNCI SCROLL
    }
  }, 300);
 }
}


    function hitungProgress(id) {
      if (evalStatus[id]) return 100;

      let progress = 0;
      const isTimeComplete = getWaktuBelajarAktif(id) >= MIN_WAKTU_BELAJAR;

      // 1. Sudah diklik/buka materi
      if (openedStatus[id]) progress += 25;
   
      // 2. Waktu minimal terpenuhi
      if (isTimeComplete) progress += 25;
    
      // 3. Checklist video/modul (masing-masing 12.5% jika ingin detail, atau 25% jika keduanya ok)
      // Kita buat: Video 25%, Modul 25%
      if (videoStatus[id]) progress += 25;
      if (modulStatus[id]) progress += 25;

      return Math.min(progress, 99); // Maksimal 99% sebelum evaluasi selesai
    }

    // Toggle status baca
    function toggleRead(id) {
      // jika sudah dibaca, tidak bisa diklik lagi
      if (readStatus[id]) return;

      // popup konfirmasi
      const yakin = confirm(
         "Apakah Anda yakin ingin mulai belajar?\nMateri akan ditandai sebagai Sudah Dibaca."
      );

      if (!yakin) return;

      // tandai sudah dibaca
      readStatus[id] = true;
      localStorage.setItem("readStatus", JSON.stringify(readStatus));

      // otomatis pindah ke menu Sudah Dibaca
      currentFilter = "read";
      setActive("btn-read");
      renderMateri("read");
    }

    function toggleCheck(id, type) {
      if (!state.checklist[id]) state.checklist[id] = { video: false, modul: false };
      state.checklist[id][type] = !state.checklist[id][type];
  
      // Simpan lokal
      localStorage.setItem("plajari_check", JSON.stringify(state.checklist)); 
  
      // SIMPAN KE CLOUD (Google Sheets)
      saveToCloud(); 
  
      renderMateri(currentFilter);
    }

    function openSertifikat(url, id) {
      if (!url) {
        alert("Link evaluasi belum tersedia.");
        return;
      }
      // Simpan data materi yang sedang dipilih
      currentEvalUrl = url;
      currentEvalId = id;

      // Tampilkan modal konfirmasi "Apakah anda siap?"
      document.getElementById("evaluasiConfirmModal").classList.add("show");
    }

    // 2. Fungsi jika user klik "Belum Siap"
    function closeEvalModal() {
      document.getElementById("evaluasiConfirmModal").classList.remove("show");
      currentEvalUrl = "";
      currentEvalId = null;
    }

    // 3. Fungsi jika user klik "Ya, Saya Siap"
    function startGoogleForm() {
      document.getElementById("evaluasiConfirmModal").classList.remove("show");

      const modal = document.getElementById("videoModal");
      const player = document.getElementById("videoPlayer");
      const title = document.getElementById("videoTitle");

      title.innerText = "Evaluasi Belajar: Selesaikan Kuis";

      let finalUrl = currentEvalUrl;
      if (!finalUrl.includes("embedded=true")) {
        finalUrl += (finalUrl.includes("?") ? "&" : "?") + "embedded=true";
      }

      player.src = finalUrl; 
      modal.classList.add("show");

      showToast("üìù Membuka lembar evaluasi..."); 

      // SIMPAN STATUS EVALUASI DISINI
      evalStatus[currentEvalId] = true;
      localStorage.setItem("evalStatus", JSON.stringify(evalStatus));

      // Tetap tandai printedStatus jika diperlukan untuk download
      printedStatus[currentEvalId] = true;
      localStorage.setItem("printedStatus", JSON.stringify(printedStatus));

      renderMateri(currentFilter);
    }
 

    function openDownload(url) {
      if (!url) {
      alert("Link download sertifikat belum tersedia.");
      return;
    }
    window.open(url, "_blank");
    }

    function markOpened(id) {
      const materi = materiList.find(m => m.id === id);
      currentActiveId = id;

      openedStatus[id] = true;
      localStorage.setItem("openedStatus", JSON.stringify(openedStatus));

      const modal = document.getElementById("videoModal");
      const player = document.getElementById("videoPlayer");
      const title = document.getElementById("videoTitle");

      title.innerText = "Mempelajari: " + materi.judul;
      player.src = materi.link; 
      modal.classList.add("show");

      studyStart[id] = Date.now();
      localStorage.setItem("studyStart", JSON.stringify(studyStart));

      readTime[id] = Date.now();
      localStorage.setItem("readTime", JSON.stringify(readTime));

      renderMateri(currentFilter);
    }

    function closeVideoModal() {
      if (currentActiveId) {
        simpanWaktuBelajar();
        currentActiveId = null;
      }
      document.getElementById("videoPlayer").src = "";
      document.getElementById("videoModal").classList.remove("show");
      renderMateri(currentFilter);
    }


    function toggleVideo(id) {
      videoStatus[id] = !videoStatus[id];
      localStorage.setItem("videoStatus", JSON.stringify(videoStatus));
      if(videoStatus[id]) showToast("üì∫ Video selesai dipelajari!"); // TAMBAHKAN INI
      renderMateri(currentFilter);
    }  

    function toggleModul(id) {
      modulStatus[id] = !modulStatus[id];
      localStorage.setItem("modulStatus", JSON.stringify(modulStatus));
      if(modulStatus[id]) showToast("üìö Modul selesai dibaca!"); // TAMBAHKAN INI
      renderMateri(currentFilter);
    }

    let selectedMateriId = null;

    function openModal(id) {
      selectedMateriId = id;
      document.getElementById("confirmModal").classList.add("show");
    }

    function closeModal() {
      document.getElementById("confirmModal").classList.remove("show");
      selectedMateriId = null;
    }

    function confirmStart() {
      if (!selectedMateriId) return;

      readStatus[selectedMateriId] = true;
      localStorage.setItem("readStatus", JSON.stringify(readStatus));
      readTime[selectedMateriId] = Date.now();
      localStorage.setItem("readTime", JSON.stringify(readTime));
      lastMovedMateriId = selectedMateriId;
      hasAutoScrolled = false;
      closeModal();
  
      showToast("‚úÖ Berhasil! Materi dipindahkan ke 'Sudah Dibaca'");

      currentFilter = "read";
      setActive("btn-read");
      renderMateri("read");
    }


    function urutkanMateriPermanen(materiArray, filter) {
      if (filter !== "read") return materiArray;

      return [...materiArray].sort((a, b) => {
        const timeA = readTime[a.id] || 0;
        const timeB = readTime[b.id] || 0;
        return timeB - timeA; // terbaru di atas
      });
    }

    function formatTanggalJam(timestamp) {
      if (!timestamp) return "";

      const d = new Date(timestamp);
      const tgl = d.toLocaleDateString("id-ID", {
        day: "2-digit",
        month: "short",
        year: "numeric"
      });
      const jam = d.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit"
      });

       return `${tgl} ‚Ä¢ ${jam}`;
    }

    function formatDurasi(ms) {
      const totalDetik = Math.floor(ms / 1000);
      const menit = Math.floor(totalDetik / 60);
      const detik = totalDetik % 60;

      return `${menit} menit ${detik.toString().padStart(2, "0")} detik`;
    }

    function getWaktuBelajarAktif(id) {
      let total = studyTime[id] || 0;

      if (studyStart[id]) {
        total += Date.now() - studyStart[id];
      }

      return total;
    }

    function getSisaWaktuBelajar(id) {
      const sudah = getWaktuBelajarAktif(id);
      const sisa = MIN_WAKTU_BELAJAR - sudah;
      return sisa > 0 ? sisa : 0;
    }

    function formatCountdown(ms) {
      const totalDetik = Math.ceil(ms / 1000);
      const menit = Math.floor(totalDetik / 60);
      const detik = totalDetik % 60;
      return `${menit.toString().padStart(2,"0")}:${detik.toString().padStart(2,"0")}`;
    }

    function simpanWaktuBelajar() {
      Object.keys(studyStart).forEach(id => {
        if (studyStart[id]) {
          const sekarang = Date.now();
          const durasiTambahan = sekarang - studyStart[id];
          studyTime[id] = (studyTime[id] || 0) + durasiTambahan;
          studyStart[id] = null; // Mematikan timer (Pause)
        }
      });
      localStorage.setItem("studyTime", JSON.stringify(studyTime));
      localStorage.setItem("studyStart", JSON.stringify(studyStart));
    }


    function updateLiveTimers() {
      const dataRender = materiList.filter(m => readStatus[m.id]);

      dataRender.forEach(materi => {
        const timerElement = document.getElementById(`timer-${materi.id}`);
        const waktuSkr = getWaktuBelajarAktif(materi.id);
        const sisa = MIN_WAKTU_BELAJAR - waktuSkr;
        const selesai = waktuSkr >= MIN_WAKTU_BELAJAR;

        // Update di kartu materi (halaman utama)
        if (timerElement) {
          timerElement.innerText = selesai ? 'SELESAI' : formatCountdown(sisa);
          if (selesai) timerElement.classList.add('timer-selesai');
        }

        // UPDATE DI POP-UP VIDEO (Jika sedang dibuka)
        if (currentActiveId === materi.id) {
          const modalTimerText = document.getElementById('modalTimerText');
          const modalTimerDisplay = document.getElementById('modalTimerDisplay');
      
          if (modalTimerText) {
            modalTimerText.innerText = selesai ? 'SUDAH MEMENUHI SYARAT (5 MENIT)' : formatCountdown(sisa);
        
            // Ubah warna jadi hijau jika sudah selesai
            if (selesai) {
              modalTimerDisplay.style.background = "#28a745";
            } else {
              modalTimerDisplay.style.background = "#8C1007";
            }
          }
        }
      });
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }

    function closeInstructionModal() {
      document.getElementById("instructionModal").classList.remove("show");
    }


    // Navigasi tab
    let currentFilter = "all";
    document.getElementById("btn-all").onclick = () => {currentFilter="all"; setActive("btn-all"); renderMateri("all");};
    document.getElementById("btn-unread").onclick = () => {currentFilter="unread"; setActive("btn-unread"); renderMateri("unread");};
    document.getElementById("btn-read").onclick = () => {currentFilter="read"; setActive("btn-read"); renderMateri("read");};

    function setActive(id){
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    setInterval(() => {
      // Selalu update stats dan live timers
      updateStats(); 
      if (currentActiveId) {
        updateLiveTimers(); 
      }
    }, 1000);

    document.addEventListener("visibilitychange", function() {
      if (!currentActiveId) return;

      if (document.hidden) {
        simpanWaktuBelajar(); // Pause saat pindah tab
      } else {
        studyStart[currentActiveId] = Date.now(); // Resume saat kembali
        localStorage.setItem("studyStart", JSON.stringify(studyStart));
      }
    });

    // Aktifkan fungsi pencarian (Letakkan di luar event listener lain)
    document.addEventListener("DOMContentLoaded", function() {
      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
        searchInput.addEventListener("input", function() {
          renderMateri(currentFilter); 
        });
      }
      
      // Jalankan pertama kali saat halaman dimuat
      updateStats();
      renderMateri("all");
    });

    // Fungsi saat tombol Masuk diklik
async function handleLogin() {
  const nip = document.getElementById('nip-input').value;
  if (!nip) return alert("Masukkan NIP!");

  const btn = document.querySelector('#login-form button');
  btn.innerText = "Loading...";
  btn.disabled = true;

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'login', nip: nip })
    });
    const data = await response.json();

    if (data.success) {
      currentUserNip = nip;
      localStorage.setItem("plajari_nip", nip);
      
      // Jika ada progres lama di cloud, timpa data lokal
      if (data.progres) {
        state = JSON.parse(data.progres);
      }
      
      showLoggedIn(data.nama);
      renderMateri("all"); // Render ulang tampilan
    } else {
      alert(data.message);
    }
  } catch (e) {
    alert("Gagal terhubung ke database. Pastikan internet aktif.");
  } finally {
    btn.innerText = "Masuk";
    btn.disabled = false;
  }
}

// Fungsi Mengirim data ke Cloud
function saveToCloud() {
  if (!currentUserNip) return;
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors', // Penting agar tidak kena error CORS
    body: JSON.stringify({
      action: 'saveProgres',
      nip: currentUserNip,
      progres: JSON.stringify(state)
    })
  });
}

function showLoggedIn(nama) {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('user-info').style.display = 'block';
  document.getElementById('user-name').innerText = nama;
}

function handleLogout() {
  localStorage.clear();
  location.reload();
}

    // Fungsi login otomatis jika sudah pernah login sebelumnya
    async function autoLogin(nip) {
      // Langsung sembunyikan modal agar tidak mengganggu yang sudah login
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('user-info-bar').classList.remove('hidden');
  
      // Ambil data terbaru dari cloud untuk sinkronisasi
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'login', nip: nip })
      });
      const data = await response.json();
  
      if (data.success) {
        document.getElementById('user-name').innerText = data.nama;
        if (data.progres) state = JSON.parse(data.progres);
        renderMateri("all");
      } else {
        // Jika NIP tiba-tiba tidak valid (dihapus admin), paksa logout
        handleLogout();
      }
    }

  </script>

    <!-- Modal Konfirmasi Mulai Belajar -->
    <div id="confirmModal" class="modal-overlay">
      <div class="modal-box">
        <h3>Konfirmasi Mulai Belajar</h3>
        <p>
          Apakah Anda yakin ingin memulai pembelajaran?<br>
          Materi akan ditandai sebagai <b>Sudah Dibaca</b>.
        </p>
        <div class="modal-actions">
          <button class="btn-cancel" onclick="closeModal()">Batal</button>
          <button class="btn-confirm" onclick="confirmStart()">Ya, Mulai</button>
        </div>
      </div>
    </div>

    <div id="evaluasiConfirmModal" class="modal-overlay">
      <div class="modal-box">
        <h3>Konfirmasi Evaluasi</h3>
        <p>
          Apakah Anda sudah siap melaksanakan evaluasi belajar?<br>
          <small style="color: #8C1007;">Pastikan koneksi internet Anda stabil.</small>
        </p>
        <div class="modal-actions">
          <button class="btn-cancel" onclick="closeEvalModal()">Belum Siap</button>
          <button class="btn-confirm" onclick="startGoogleForm()">Ya, Saya Siap</button>
        </div>
       </div>
     </div>

    <div id="videoModal" class="modal-overlay">
      <div class="modal-box" style="max-width: 900px; width: 95%; height: 90vh; display: flex; flex-direction: column;">
    
        <h3 id="videoTitle" style="margin-bottom: 10px;">Memutar Video Materi</h3>

        <div id="modalTimerDisplay" style="background: #8C1007; color: #fff; padding: 8px; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
            <i class="fas fa-clock"></i> Sisa Waktu Belajar Minimal: 
            <span id="modalTimerText" style="font-weight: bold; font-family: monospace; font-size: 16px;">00:00</span>
        </div>
   
        <div style="flex-grow: 1; position: relative; background: #000; border-radius: 8px; overflow: hidden;">
          <iframe id="videoPlayer" 
            style="position: absolute; top:0; left:0; width:100%; height:100%;" 
            src="" 
            frameborder="0" 
            allow="autoplay; fullscreen" 
            allowfullscreen>
          </iframe>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" onclick="closeVideoModal()">Tutup & Pause Belajar</button>
        </div>
      </div>
    </div>

  <div id="toast"></div>

  <div id="instructionModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 450px;">
      <div style="font-size: 50px; margin-bottom: 10px;">üí°</div>
      <h3 style="color: #1B3C53;">Materi Berhasil Dipindahkan!</h3>
      <p style="text-align: left; font-size: 14px; line-height: 1.6; color: #444;">
        Silakan selesaikan pembelajaran dengan alur berikut:
      </p>
      <ul style="text-align: left; font-size: 14px; color: #444; padding-left: 20px;">
        <li>Klik tombol <b>"Lihat Video Materi"</b>.</li>
        <li>Pelajari materi minimal selama <b>5 menit</b> (pantau timer).</li>
        <li>Ceklis status <b>Video</b> dan <b>Modul</b> jika sudah selesai.</li>
        <li>Tombol <b>Evaluasi</b> akan aktif jika syarat sudah terpenuhi.</li>
      </ul>
      <div class="modal-actions">
        <button class="btn-confirm" onclick="closeInstructionModal()" style="width: 100%;">Saya Mengerti, Lanjutkan</button>
      </div>
    </div>
  </div>



</body>
</html>
